* Create new application (deps.edn)

  Understanding the new tools.build tool chain
  https://www.youtube.com/watch?v=BTAx-gFz6Ks
  
  Then progress to deps-new
  https://github.com/seancorfield/deps-new

  Note there is a problem for Windows, but not for Mac.
  https://github.com/seancorfield/deps-new/issues/25
* Leiningen and Cider troubles

If you're having the following problem

#+begin_src 
nrepl-send-sync-request: Wrong type argument
#+end_src

https://gitter.im/syl20bnr/spacemacs/archives/2018/12/16

#+begin_quote
kouvas @kouvas Dec 16 2018 15:23
anyone knows why i get error "Wrong type argument: strings, nil" when I try to evaluate a Clojure code block in org-mode? I have loaded clojure and python org-label support in userconfig but only python works fine
^"... stringp, nil"

yuhan0 @yuhan0 Dec 16 2018 15:28
Unless I'm mistaken, the org file has to be inside a clojure project with cider already jacked in
Is that the case for you? The error message could definitely be more informative in that regard

kouvas @kouvas Dec 16 2018 15:39
executing Clojure code block...
nrepl-send-sync-request: Wrong type argument: stringp, nil
you are right :) forgot to check the message buffer
so there is not other way? I would like to use a general clojure org file for note taking and examples

Compro Prasad @Compro-Prasad Dec 16 2018 15:40
you can check where the error is coming from
use M-x toggle-debug-on-error
#+end_quote

https://cider.readthedocs.io/en/latest/up_and_running/

https://github.com/technomancy/leiningen/blob/stable/doc/TUTORIAL.md

brew install leiningen
* Getting started Tutorial
Tutorial:
https://www.youtube.com/watch?v=SPSn02RxpxM

which tracks this larger blog tutorial:
https://practicalli.github.io/blog/posts/clojure-web-server-cli-tools-deps-edn/


Starting repl in cider https://youtu.be/SPSn02RxpxM?t=3848

You can still add lein?
* DONE Adding Clojure to your App
  CLOSED: [2019-10-24 Thu 17:26]
** DONE Understanding Clojure & the REPL
   CLOSED: [2019-10-20 Sun 10:58]

(First technically add the clojure jars to your project)

Clojure in most cases is always the REPL.
Although it's possible to compile out clojure code to Java classes as seen here https://www.innoq.com/en/blog/native-clojure-and-graalvm/
this is not generally how code is run.
Therefore you always start a REPL on the JVM and then load clojure code.
This can _also_ be done in a server/client way using something like nRepl.

This is a good introduction to both repls and nrepl
https://lambdaisland.com/guides/clojure-repls/clojure-repls


Further nRepl links
https://github.com/clojure/tools.nrepl
https://nrepl.org/nrepl/0.6.0/index.html

The following is interesting tools
https://stackoverflow.com/questions/26743958/why-cant-i-print-from-background-threads-in-clojure-cider-repl-in-emacs

Starting with Clojure for a Java programmer: https://youtu.be/P76Vbsk_3J0?t=2936
** DONE Set up a repl in your program
   CLOSED: [2019-09-25 Wed 23:07]

NOTE The following is out of date:
  https://gist.github.com/mbobesic/bbdea9a1fae1927057b8

See https://github.com/nrepl/nrepl
https://mvnrepository.com/artifact/nrepl/nrepl/0.6.0

Remember to add clojars as the repository.
#+begin_src 
repositories {
  maven { url "https://clojars.org/repo" }
}
#+end_src


Also pay attention to 
https://clojure.org/reference/java_interop#_calling_clojure_from_java

and the rest of the page in general for tips on interop.
** DONE Connect to an existing repl
   CLOSED: [2019-09-25 Wed 23:06]
 https://practicalli.github.io/spacemacs/clojure-repl/connect-to-running-repl.html

 As the guide above states:
 #+begin_src 
 M-x cider-connect ;; Then type in host and port number
 [nREPL] Establishing direct connection to localhost:8083 ...
 [nREPL] Direct connection to localhost:8083 established
 #+end_src
** DONE Accessing the buffer
   CLOSED: [2019-09-25 Wed 23:05]

Now see the following, but ignore the Vim bindings and look for the emacs ones lower on the page.
https://practicalli.github.io/spacemacs/clojure-repl/switching-to-repl.html

Note that if you connect from a .clj file that is linked to another buffer or more stringent
still, is a clojure project, then you won't be able to immediately go to the buffer with the 
command M-x cider-switch-to-repl-buffer.

Switch to the nRepl with [C-x b] as appropriate.

Note that with Spacemacs the [C-x b] may cut off the buffer name.
#+begin_src 
;; The default of 20 cuts off clojure repl buffer information helpful to locate it.
  (setq helm-buffer-max-length 30)
#+end_src

The above isn't a complete fix because the file name is too long still!
However you can filter the list by port number with [C-x b] by typing the port number even if you cannot see it!
** DONE Cannot print to stdout of original executing program
   CLOSED: [2019-10-20 Sun 16:50]
 But when we try and print to system out of our running programming where-in the REPL is launched from

 #+begin_src 
 user> (println "Hello world")
 Hello world
 nil
 user>
 #+end_src

NOTE The standard out comes out via Cider and not the originating program.

Make sure you read the nrepl help link listed in the first section.

However the following will use the applications System.out

#+begin_src 
(.println (System/out) "hi")
#+end_src

However once the cider-nrepl is plugged in it might stop working again
https://github.com/clojure-emacs/cider-nrepl/blob/master/src/cider/nrepl/middleware/out.clj

This is by design. Instead try the following if logging is on the classpath.

#+begin_src 
(. (. org.slf4j.LoggerFactory getLogger "Test logger") info "Test Message")
#+end_src


** DONE Getting your project up to scratch with Gradle
   CLOSED: [2019-10-24 Thu 00:34]
Given we're starting with a Gradle project we could look to include something like this
https://github.com/clojurephant/clojurephant


#+begin_comment
What happens if you try to add compilation directories manually:
Or https://discuss.gradle.org/t/add-to-dependencies-classpath/7281/10
Not a good idea because this appears not to be a source set, 
and IntelliJ is confused about file paths something like
https://stackoverflow.com/questions/30577665/disable-intellij-source-root-inspection
#+end_comment

However clojurephant may rely on latest version of gradle or you'll get the following:
 #+begin_src 
 org.gradle.internal.exceptions.LocationAwareException: Build file '/Users/dmg46664/IdeaProjects/precollate/build.gradle' line: 19
 An exception occurred applying plugin request [id: 'dev.clojurephant.clojure', version: '0.5.0-alpha.5']
	 at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator.applyPlugin(DefaultPluginRequestApplicator.java:232)
	 at java.lang.Thread.run(Thread.java:748)
 Caused by: org.gradle.api.plugins.InvalidPluginException: An exception occurred applying plugin request [id: 'dev.clojurephant.clojure', version: '0.5.0-alpha.5']
	 at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator.exceptionOccurred(DefaultPluginRequestApplicator.java:247)
	 at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator.applyPlugin(DefaultPluginRequestApplicator.java:229)
	 ... 105 more
 Caused by: org.gradle.api.internal.plugins.PluginApplicationException: Failed to apply plugin [class 'dev.clojurephant.plugin.clojure.ClojureBasePlugin']
	 at org.gradle.api.internal.plugins.DefaultPluginManager.doApply(DefaultPluginManager.java:160)
	 at org.gradle.api.internal.plugins.DefaultPluginManager.addImperativePlugin(DefaultPluginManager.java:85)

	 at org.gradle.api.internal.plugins.DefaultPluginManager.apply(DefaultPluginManager.java:130)
	 at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator$3.run(DefaultPluginRequestApplicator.java:151)
	 at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator.applyPlugin(DefaultPluginRequestApplicator.java:225)
	 ... 105 more
 Caused by: java.lang.NoSuchMethodError: org.gradle.api.model.ObjectFactory.directoryProperty()Lorg/gradle/api/file/DirectoryProperty;
	 at dev.clojurephant.plugin.clojure.ClojureExtension.<init>(ClojureExtension.java:13)
	 at dev.clojurephant.plugin.clojure.ClojureExtension_Decorated.<init>(Unknown Source)
	 at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	 at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
	 at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	 at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
	 at org.gradle.internal.reflect.DirectInstantiator.newInstance(DirectInstantiator.java:51)
	 ... 146 more


 #+end_src

For Mac, be aware of upgrading bash for sdkman, and then sdkman updgrade gradle.
https://merikan.com/2019/04/upgrade-to-bash-5-in-macos/

You may still have problems connecting from Emacs Cider, to a separate application.
(It should work if jack'ing in from Leiningen or build systems that support passing dependencies)
https://github.com/clojurephant/clojurephant/issues/78

In order to get around this use a cider nrepl handler
https://docs.cider.mx/cider-nrepl/usage.html#_via_embedding_nrepl_in_your_app
https://clojars.org/cider/cider-nrepl

** DONE Hotloading your own files
   CLOSED: [2019-10-24 Thu 00:36]

The first problem is to make sure when you invoke Clojure that it can see local script files.
If you've got clojure onto the classpath AND your local files onto the classpath (See clojurephant in the previous sections), then you should be able to do the following:

#+begin_src 
      require.invoke(Clojure.read("accounts.localscript"));
      IFn localscript = Clojure.var("accounts.localscript", "hello-world");
      localscript.invoke();
#+end_src

src/main/clojure/accounts/localscript.clj
#+begin_src 
(ns accounts.localscript)

(defn hello-world []
  (println "Hello world"))
#+end_src


** TODO Refactoring not working via NREPL & clojurephant

See everything written up here:
https://github.com/clojurephant/clojurephant/issues/131

https://github.com/clojure-emacs/clj-refactor.el#setup
#+begin_src 
On the other hand if a standalone REPL or an embedded nREPL server is used you will need to manually add this dependency (see below).

Either in your project's project.clj or in the :user profile found at ~/.lein/profiles.clj:

:plugins [[refactor-nrepl "2.4.0"]
          [Cider/cider-nrepl "0.18.0"]]
#+end_src

So added to clojurephant

#+begin_src 
implementation 'refactor-nrepl:refactor-nrepl:2.4.0'
#+end_src

But still getting the following error
#+begin_src 
WARNING: clj-refactor and refactor-nrepl are out of sync.
Their versions are 2.5.0-SNAPSHOT (package: 20190618.716) and n/a, respectively.
You can mute this warning by changing cljr-suppress-middleware-warnings.
#+end_src

Interesting:
https://github.com/clojure-emacs/cider/issues/2511#issuecomment-435767772

Some background on the warning https://github.com/clojure-emacs/clj-refactor.el/pull/392
https://github.com/clojure-emacs/cider/pull/2238

Trying to find out more about instantiating middleware:
https://cljdoc.org/d/nrepl/nrepl/0.5.3/doc/design/middleware

Strategy might be to look at how boot manually instantiates middleware and try and do the same
- https://clojuredocs.org/clojure.core/swap!

Need to add understanding about nrepl and piggie backing.
https://github.com/nrepl/piggieback#embedded



See this stack of advice:
https://docs.cider.mx/cider-nrepl/usage.html#_via_embedding_nrepl_in_your_app
which links to 
https://github.com/clojure-emacs/cider-nrepl/issues/447
which references:
https://github.com/clojure-emacs/cider-nrepl/issues/464


** TODO Why does autocompletion not work?

https://github.com/clojure-emacs/cider/issues/2528



** TODO Adding REBL to lein and cider

#+begin_src
Execution error (FileNotFoundException) at cognitect.rebl.impl.monaco/loading (monaco.clj:3).
Could not locate cljfmt/core__init.class, cljfmt/core.clj or cljfmt/core.cljc on classpath.
ERROR: Unhandled REPL handler exception processing message {:nrepl.middleware.print/stream? 1, :nrepl.middleware.print/print cider.nrepl.pprint/pprint, :nrepl.middleware.print/quota 1048576, :nrepl.middleware.print/options {:right-margin 80}, :op stacktrace, :session 33d17ac2-413a-48d7-a8b4-37425257220f, :id 23}
java.lang.NoClassDefFoundError: Could not initialize class cognitect.rebl.ui__init
	at java.base/java.lang.Class.forName0(Native Method)
	at java.base/java.lang.Class.forName(Class.java:416)
	at clojure.lang.RT.classForName(RT.java:2207)
	at clojure.lang.RT.classForName(RT.java:2216)
	at clojure.lang.Compiler.maybeResolveIn(Compiler.java:7437)
	at clojure.core$ns_resolve.invokeStatic(core.clj:4370)
	at clojure.core$ns_resolve.invokeStatic(core.clj:4359)
	at clojure.core$ns_resolve.invoke(core.clj:4359)
	at cider.nrepl.inlined_deps.orchard.v0v5v5.orchard.java$resolve_class$fn__8010.invoke(java.clj:310)
	at cider.nrepl.inlined_deps.orchard.v0v5v5.orchard.java$resolve_class.invokeStatic(java.clj:310)
#+end_src

Or from the terminal after upgrading lein to 2.9.3

#+begin_src 
lein repl
dmg46664.etl=> (require '[cognitect.rebl :as rebl])
nil
dmg46664.etl=> (rebl/ui)
Execution error (FileNotFoundException) at cognitect.rebl.impl.monaco/loading (monaco.clj:3).
Could not locate cljfmt/core__init.class, cljfmt/core.clj or cljfmt/core.cljc on classpath.
#+end_src

Might want to try https://github.com/RickMoynihan/nrebl.middleware

Perhaps it doesn't work with symlinks of the jar?
Adding the dependency as per comment here fixes this https://github.com/cognitect-labs/REBL-distro/issues/34
* DONE ReactNative & Shadow-cljs
  CLOSED: [2020-11-16 Mon 12:43]

  NOTE Don't use the following https://github.com/flexsurfer/ClojureRNProject
  Pros and cons
   + Uses yarn
   - Shouldn't put react-native directory in root
   - duplicates dependencies
   - hides shims
   - despoke libs

  Use this as a guide instead https://github.com/thheller/reagent-react-native
  OR EVEN BETTER
  https://github.com/thheller/reagent-expo for use with expo
  Official docs :https://docs.expo.dev/get-started/create-a-new-app/
  - After expo init, choose minimal.
    (Need an expo account)
  - expo build:android

    https://docs.expo.dev/bare/installing-updates/

  
  NOTE However, see modern advice on create reactnative apps https://stackoverflow.com/a/45780332/93074
  #+begin_src
    brew install yarn
    yarn global add create-react-native-app
    create-react-native-app
     #selecting default app, new-name
    mv new-name react-native
    yarn init -y
    yarn add --dev shadow-cljs
    #+end_src

    Now complete rest of guide as is

    NOTE but advise in favour of committing the repo before building

Connecting with cider definitely works when jacking in, but not with connecting.

Apparently another way
    https://github.com/clojure-emacs/cider-nrepl/issues/638

#+begin_src cljs
shadow.user> (shadow/repl :app)
or shadow.user> (shadow.cljs.devtools.api/nrepl-select :app)
To quit, type: :cljs/quit
cljs.user> (in-ns 'dimigi.test)
(ns-publics 'dimigi.test)
    #+end_src

See https://www.youtube.com/watch?v=Ykztwp2DXjs and comment for cljs and cider-nrepl.
    
    See https://clojurians-log.clojureverse.org/tools-build/2021-10-05
** TODO https://stackoverflow.com/questions/47150410/failed-to-run-sdkmanager-list-with-java-9

   
    
** DONE ERROR Invariant Violation: "main" has not been registered
   CLOSED: [2020-11-17 Tue 14:06]
   This can happen if:
 Metro (the local dev server) is run from the wrong folder. Check if Metro is running, stop it and restart it in the current project.
 A module failed to load due to an error and `AppRegistry.registerComponent` wasn't called.

 https://stackoverflow.com/questions/29287987/invariant-violation-application-awesomeproject-has-not-been-registered-when-b

 Seems I needed to change render-root to "main"
** DONE error: Error: Unable to resolve module `react-native-safe-area-context`
   CLOSED: [2020-11-16 Mon 12:18]
   from `app/index.js`: react-native-safe-area-context could not be found within the project.

    https://stackoverflow.com/questions/59560312/getting-this-error-error-bundling-failed-error-unable-to-resolve-module-rea

    ❯ yarn add react-native-safe-area-view react-native-safe-area-context
yarn add v1.22.10
warning package-lock.json found. Your project contains lock files generated by tools other than Yarn. It is advised not to mix package managers in order to avoid resolution inconsistencies caused by unsynchronized lock files. To clear this warning, remove package-lock.json.
[1/4] 🔍  Resolving packages...
[2/4] 🚚  Fetching packages...
[3/4] 🔗  Linking dependencies...
warning "@react-native-community/eslint-config > @typescript-eslint/eslint-plugin > tsutils@3.17.1" has unmet peer dependency "typescript@>=2.8.0 || >= 3.2.0-dev || >= 3.3.0-dev || >= 3.4.0-dev || >= 3.5.0-dev || >= 3.6.0-dev || >= 3.6.0-beta || >= 3.7.0-dev || >= 3.7.0-beta".
[4/4] 🔨  Building fresh packages...
success Saved lockfile.
success Saved 3 new dependencies.
info Direct dependencies
├─ react-native-safe-area-context@3.1.9
└─ react-native-safe-area-view@1.1.1
info All dependencies
├─ hoist-non-react-statics@2.5.5
├─ react-native-safe-area-context@3.1.9
└─ react-native-safe-area-view@1.1.1
✨  Done in 10.32s.

Now I get:

[Mon Nov 16 2020 06:28:34.348]  ERROR    Invariant Violation: requireNativeComponent: "RNCSafeAreaView" was not found in the UIManager.

This error is located at:
    in RNCSafeAreaView (created by samson.core.root_comp)
    in samson.core.root_comp (created by reagent1)
    in RCTView (at View.js:34)
    in View (created by reagent1)
    in reagent1 (at renderApplication.js:45)
    in RCTView (at View.js:34)
    in View (at AppContainer.js:106)
    in RCTView (at View.js:34)
    in View (at AppContainer.js:132)
    in AppContainer (at renderApplication.js:39)

Then to reinstall the new native dependencies
yarn android
** DONE DEPRECATED Setting up a clojurescript reactnative using re-natal
   CLOSED: [2022-01-27 Thu 12:37]

 Advice: Lots to download both during project generation and first run.
 Make sure you have bandwidth.

 The following should be deprecated https://github.com/drapanjanas/re-natal
 In favour of https://figwheel.org/docs/react-native.html
*** DONE Problems installing re-natal
    CLOSED: [2020-10-05 Mon 13:59]
 #+begin_src 
 ❯ npm install -g react-native-cli
 added 83 packages from 28 contributors in 6.681s
 ❯ brew install watchman

 ❯ npm install -g re-natal
 dyld: Library not loaded: /usr/local/opt/icu4c/lib/libicui18n.62.dylib
 !!! But don't run `brew upgrade` to solve this.
 #+end_src

 Ran brew upgrade in order to get passed the above error, which worked but was heavy handed.
*** DONE Problems running Android.
    CLOSED: [2020-10-05 Mon 13:59]
 Next you have to install android sdk or you'll get this.

 #+begin_src
 > SDK location not found. Define location with sdk.dir in the local.properties file or with an ANDROID_HOME environment variable.
 !!! This means you have to setup Android


 NOTE The following is deprecated:
 brew cask install android-sdk

 See
 https://developer.android.com/studio/releases/sdk-tools

 But this apparently works?

 brew cask install android-studio

 DONE This seemed to work.
 #+end_src

 Check where Android sdk was installed
 #+begin_src bash
 export ANDROID_HOME=~/Library/Android/sdk
 #+end_src

 #+begin_src
 ❯ react-native run-android
 (node:5471) Warning: Accessing non-existent property 'padLevels' of module exports inside circular dependency
 (Use `node --trace-warnings ...` to show where the warning was created)
 info Starting JS server...
 info Building and installing the app on the device (cd android && ./gradlew app:installDebug)...

 > Configure project :app
 File /Users/dmg46664/.android/repositories.cfg could not be loaded.
 Checking the license for package Android SDK Build-Tools 28.0.3 in /Users/dmg46664/Library/Android/sdk/licenses
 Warning: License for package Android SDK Build-Tools 28.0.3 not accepted.
 Checking the license for package Android SDK Platform 28 in /Users/dmg46664/Library/Android/sdk/licenses
 Warning: License for package Android SDK Platform 28 not accepted.

 FAILURE: Build failed with an exception.

 - What went wrong:
 A problem occurred configuring project ':app'.
 > Failed to install the following Android SDK packages as some licences have not been accepted.
      build-tools;28.0.3 Android SDK Build-Tools 28.0.3
      platforms;android-28 Android SDK Platform 28
   To build this project, accept the SDK license agreements and install the missing components using the Android Studio SDK Manager.
   Alternatively, to transfer the license agreements from one workstation to another, see http://d.android.com/r/studio-ui/export-licenses.html

   Using Android SDK: /Users/dmg46664/Library/Android/sdk

 - Try:
 Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

 - Get more help at https://help.gradle.org

 BUILD FAILED in 5s
 error Could not install the app on the device, read the error above for details.
 Make sure you have an Android emulator running or a device connected and have
 set up your Android development environment:
 https://facebook.github.io/react-native/docs/getting-started.html
 error Command failed: ./gradlew app:installDebug. Run CLI with --verbose flag for more details.
     ~/IdeaProjects/samson 
 #+end_src

 But it still doesn't run from the command line!?
 DONE So loaded the android directory into android studio itself.
 DONE Upgraded the gradle plugin

 DONE Updated the build numbers to what seems to match in my
 ~/Library/Android/sdk/platforms/android-30

 #+begin_src json
 buildscript {
     ext {
         buildToolsVersion = "30.0.2"
         minSdkVersion = 16
         compileSdkVersion = 30
         targetSdkVersion = 30
         supportLibVersion = "30.0.0"
     }
 #+end_src

 TODO But still problematic

 #+begin_src
 Failed to install the following Android SDK packages as some licences have not been accepted.
    build-tools;29.0.2 Android SDK Build-Tools 29.0.2
 To build this project, accept the SDK license agreements and install the missing components using the Android Studio SDK Manager.
 Alternatively, to transfer the license agreements from one workstation to another, see http://d.android.com/r/studio-ui/export-licenses.html

 Using Android SDK: /Users/dmg46664/Library/Android/sdk
 Install missing SDK package(s)
 #+end_src

 TODO perhaps the following?

 #+begin_src
 Fixed adding the following:

 yes | sdkmanager --licenses && yes | sdkmanager --update

 This needs to be executed before any interaction with Android SDK.

 For Mac follow the images here downloading
 https://stackoverflow.com/questions/54273412/failed-to-install-the-following-android-sdk-packages-as-some-licences-have-not

 The following doesn't work. Perhaps needs JAVA_HOME is too new a version
 ~/Library/Android/sdk/tools/bin/sdkmanager --licenses
 #+end_src

 TODO Running device from AVG Manager

 Chose Pixel 3a and downloaded.
*** DONE Getting Figwheel to work as expected
    CLOSED: [2020-10-05 Mon 13:59]
 How to start the project in Emacs:
 #+begin_src
 At the command prompt:

 re-natal use-android-device avd
 re-natal use-figwheel

 Then in Emacs:
 Jack in to CLJS
 (switch-to-build "android")
 #+end_src

 #+begin_src clojure
 user> (fig-status)
 Figwheel System Status
 ----------------------------------------------------
 Watching builds: [android]
 Client Connections
	  any-build: 1 connection
 ----------------------------------------------------
 nil
 #+end_src

 DONE Now you'll be able to save changes and see them in the emulator!

 However, you'll find that at this point you've lost the ability to run arbitrary REPL
 code in emacs.
*** DONE Run arbitrary REPL code in Emacs
    CLOSED: [2020-10-05 Mon 15:09]

    https://figwheel.org/docs/editor-integration.html

 Perhaps the problem happened here:

 #+begin_src
 Prompt will show when Figwheel connects to your application

 user> (switch-to-build "android")
 !!! sleep interrupted
 Exception Failed to launch Figwheel CLJS REPL: nREPL connection found but unable to load piggieback.
 This is commonly caused by
  A) not providing piggieback as a dependency and/or
  B) not adding piggieback middleware into your nrepl middleware chain.

 example profile.clj code:
 -----
 :profiles {:dev {:dependencies [[cider/piggieback <current-version>]
                                 [org.clojure/tools.nrepl  <current-version>]]
                  :repl-options {:nrepl-middleware [cider.piggieback/wrap-cljs-repl]}}}
 -----
 Please see the documentation for piggieback here https://github.com/clojure-emacs/piggieback#installation

 Note: Cider will inject this config into your project.clj.
 This can cause confusion when your are not using Cider.  figwheel-sidecar.repl/eval19040/fn--19041 (repl.clj:182)
 Figwheel: Stopped watching build - ios
 Figwheel: Watching build - android
 Compiling build :android to "target/android/index.js" from ["src" "env/dev"]...
 Successfully compiled build :android to "target/android/index.js" in 3.043 seconds.
 nil
 #+end_src

 Interesting read
 https://github.com/bhauman/lein-figwheel/issues/703

 DONE See starting android first for the solution FIX!
 Once Android starts first then figwheel loads in the right order and waits
 to connect to your application with the CLJS REPL.
 If it loads ios first and then you switch it seems to fail for some reason.
*** DONE Figwheel-main doesn't work
    CLOSED: [2020-10-05 Mon 16:40]

 So the CIDER instructions suggest not booting wth `figwheel` and choosing `figwheel-main`.
 However I get the latter with that instruction
 #+begin_src
 [nREPL] Starting server via /usr/local/bin/lein update-in :dependencies conj \[nrepl\ \"0.8.2\"\] -- update-in :dependencies conj \[cider/piggieback\ \"0.5.1\"\] -- update-in :plugins conj \[refactor-nrepl\ \"2.5.0\"\] -- update-in :plugins conj \[cider/cider-nrepl\ \"0.25.3\"\] -- repl :headless :host localhost
 Invalid face reference: t [740 times]
 [nREPL] server started on 61524
 Invalid face reference: t [40 times]
 error in process filter: user-error: No figwheel-main build files (<build-id>.cljs.edn) were found
 error in process filter: No figwheel-main build files (<build-id>.cljs.edn) were found
 Invalid face reference: t [63 times]
 #+end_src

 Some commentary here? About how a whole project interacts, but not that illuminating for this issue.
 https://luminusweb.com/docs/clojurescript.html

 I don't think it works with figwheel-main, so reverting to figwheel


 TODO Newer version fo bridge? Is the whole project invalidated?
 https://github.com/drapanjanas/re-natal/issues/209
 This bridge is interest
*** DONE How to get reframe/re-agent to automatically reload stuff on screen if the values have changed?
    CLOSED: [2020-10-05 Mon 16:40]
    I.e. if I save db.clj with a new value,
    It doesn't automatically reload.

    Neither is this the case with
 This whole project is deprecated with https://figwheel.org/docs/react-native.html
   
*** DONE Why isn't it starting with android first?
    CLOSED: [2020-10-05 Mon 15:14]
    Perhaps the reason is https://cljdoc.org/d/figwheel-sidecar/figwheel-sidecar/0.5.20/doc/readme

    In project.clj swap the following
 #+begin_src clojure
   ;; Swap the order in the vector of ios and android builds
   :profiles :dev :cljsbuild :builds

   ;; Then rerun

        ;;
        ;; ClojureScript REPL type: figwheel
        ;; ClojureScript REPL init form: (do (require 'figwheel-sidecar.repl-api) (figwheel-sidecar.repl-api/start-figwheel!) (figwheel-sidecar.repl-api/cljs-repl))
        ;;
        Figwheel: Starting server at http://0.0.0.0:3449
        Figwheel: Watching build - android
        Compiling build :android to "target/android/index.js" from ["src" "env/dev"]...
        Successfully compiled build :android to "target/android/index.js" in 15.003 seconds.
        Launching ClojureScript REPL for build: android
        Figwheel Controls:
                  (stop-autobuild)                ;; stops Figwheel autobuilder
                  (start-autobuild id ...)        ;; starts autobuilder focused on optional ids
                  (switch-to-build id ...)        ;; switches autobuilder to different build
                  (reset-autobuild)               ;; stops, cleans, and starts autobuilder
                  (reload-config)                 ;; reloads build config and resets autobuild
                  (build-once id ...)             ;; builds source one time
                  (clean-builds id ..)            ;; deletes compiled cljs target files
                  (print-config id ...)           ;; prints out build configurations
                  (fig-status)                    ;; displays current state of system
                  (figwheel.client/set-autoload false)    ;; will turn autoloading off
                  (figwheel.client/set-repl-pprint false) ;; will turn pretty printing off
          Switch REPL build focus:
                  :cljs/quit                      ;; allows you to switch REPL to another build
            Docs: (doc function-name-here)
            Exit: :cljs/quit
         Results: Stored in vars *1, *2, *3, *e holds last exception object
        Prompt will show when Figwheel connects to your application
        To quit, type: :cljs/quit
        nil
        user> 
        cljs.user> 
    #+end_src
** DONE DEPRECATED ReactNative with ClojureScript and figWheel
   CLOSED: [2020-11-12 Thu 13:39]
   https://figwheel.org/docs/react-native.html

 NOTE Rather use shadow-cljs
  
 When reading the above add a
 android.cljs.edn instead of the ios.

 #+begin_src sh
 user-error: The clojure executable isn’t on your ‘exec-path’
 #+end_src

 Check if you can run `clj` from the command line.

 #+begin_src shell
 brew install clojure/tools/clojure
 Error: No available formula or cask with the name "clojure/tools/clojure".

 ❯ brew install clojure
 Updating Homebrew...
 ==> Auto-updated Homebrew!
 Updated 1 tap (homebrew/cask).
 ==> Updated Casks
 praat

 Warning: clojure 1.10.1.697 is already installed, it's just not linked
 You can use `brew link clojure` to link this version.
 ❯ clj
 zsh: command not found: clj
 ❯ brew link clojure
 Linking /usr/local/Cellar/clojure/1.10.1.697... 8 symlinks created
 ❯ clj DONE
 #+end_src

 Not able to communicate yet

 #+begin_src
 [Error: Figwheel Bridge Unable to fetch optionsUrl: http://localhost:9500/cljs-out/android/cljsc_opts.json]
 #+end_src

 #+begin_src shell
 Change path
 export PATH=$HOME/bin:/usr/local/bin:~/Library/Android/sdk/platform-tools:$PATH
 #+end_src

 Now run adb command as per tutorial
*** TODO ERROR evaluating SECRET_INTERNALS_DO_NOT
 #+begin_src 
 TypeError: Cannot read property '__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED' of undefined
     at eval (eval at tryCallOne (core.js:37), <anonymous>:18:36)
     at eval (eval at tryCallOne (core.js:37), <anonymous>:15:29)
     at eval (eval at tryCallOne (core.js:37), <anonymous>:16:2)
     at eval (<anonymous>)
     at tryCallOne (core.js:37)
     at core.js:123
     at JSTimers.js:274
     at _callTimer (JSTimers.js:130)
     at _callImmediatesPass (JSTimers.js:181)
     at MessageQueue.callImmediates [as _immediatesCallback] (JSTimers.js:441)
 reactConsoleErrorHandler @ ExceptionsManager.js:179
 n @ backend.js:32
 registerError @ LogBox.js:148
 errorImpl @ LogBox.js:59
 console.error @ LogBox.js:33
 tryCallOne @ core.js:37
 (anonymous) @ core.js:123
 (anonymous) @ JSTimers.js:274
 _callTimer @ JSTimers.js:130
 _callImmediatesPass @ JSTimers.js:181
 callImmediates @ JSTimers.js:441
 __callImmediates @ MessageQueue.js:387
 (anonymous) @ MessageQueue.js:135
 __guard @ MessageQueue.js:364
 flushedQueue @ MessageQueue.js:134
 invokeCallbackAndReturnFlushedQueue @ MessageQueue.js:130
 (anonymous) @ debuggerWorker.cff11639.js:4
    #+end_src


 TODO I might have got this after adding depedencies?
 Hypothesis, adding the dependencies complicated the complication of core.js

 https://github.com/facebook/react-native/issues/13874

 ;;/Users/dmg46664/IdeaProjects/Samson/target/public/cljs-out/android/cljs/core.js
 /Users/dmg46664/IdeaProjects/Samson/node_modules/promise/core.js

 TODO https://github.com/thheller/shadow-cljs/issues/31

 TODO "A note to anyone else trying to run RN from master. Double check the react version in RN's package.json matches the one in your app's yarn lockfile."
*** DONE Error: Figwheel Bridge Unable to fetch optionsUrl:
    CLOSED: [2020-11-12 Thu 10:48]
    http://localhost:9500/cljs-out/android/cljsc_opts.json


    It's likely that you get this error when the reverse proxy with adb hasn't run.
    Because the emulator can't yet see the REPL server

    You should see the following in the metro task
   
 #+begin_src shell
 [Wed Nov 11 2020 22:05:43.960]  LOG      Running "Samson" with {"rootTag":1}
 [Wed Nov 11 2020 22:05:43.363]  ERROR    [Error: Figwheel Bridge Unable to fetch optionsUrl: http://localhost:9500/cljs-out/android/cljsc_opts.json]
 [Thu Nov 12 2020 10:45:15.927]  BUNDLE  ./index.js

 [Thu Nov 12 2020 10:45:24.810]  LOG      Running "Samson" with {"rootTag":1}
 [Thu Nov 12 2020 10:45:38.904]  LOG       [goog.net.WebSocket] Opening the WebSocket on ws://localhost:9500/figwheel-connect?fwprocess=2ecd9b&fwbuild=android&fwsid=5d44fc9a-3ef1-4d86-a701-86bfa453fac9
 [Thu Nov 12 2020 10:45:40.833]  LOG       [goog.net.WebSocket] WebSocket opened on ws://localhost:9500/figwheel-connect?fwprocess=2ecd9b&fwbuild=android&fwsid=5d44fc9a-3ef1-4d86-a701-86bfa453fac9
 [Thu Nov 12 2020 10:45:41.147]  LOG       [Figwheel REPL] Session ID: 5d44fc9a-3ef1-4d86-a701-86bfa453fac9
 [Thu Nov 12 2020 10:45:41.148]  LOG       [Figwheel REPL] Session Name: Jolie
 #+end_src

 Probably ADB reverse proxy solves this.
*** DONE error: Error: Unable to resolve module `./target/public/cljs-out/android/krell_assets.js` from `index.js`:
    CLOSED: [2020-11-12 Thu 14:55]

 From metro bundler
 #+begin_src
 None of these files exist:
   * target/public/cljs-out/android/krell_assets.js(.native|.android.js|.native.js|.js|.android.json|.native.json|.json|.android.ts|.native.ts|.ts|.android.tsx|.native.tsx|.tsx)
   * target/public/cljs-out/android/krell_assets.js/index(.native|.android.js|.native.js|.js|.android.json|.native.json|.json|.android.ts|.native.ts|.ts|.android.tsx|.native.tsx|.tsx)
     at ModuleResolver.resolveDependency (/Users/dmg46664/IdeaProjects/Samson/node_modules/metro/src/node-haste/DependencyGraph/ModuleResolution.js:163:15)
     at ResolutionRequest.resolveDependency (/Users/dmg46664/IdeaProjects/Samson/node_modules/metro/src/node-haste/DependencyGraph/ResolutionRequest.js:52:18)
     at DependencyGraph.resolveDependency (/Users/dmg46664/IdeaProjects/Samson/node_modules/metro/src/node-haste/DependencyGraph.js:287:16)
     at Object.resolve (/Users/dmg46664/IdeaProjects/Samson/node_modules/metro/src/lib/transformHelpers.js:267:42)
     at /Users/dmg46664/IdeaProjects/Samson/node_modules/metro/src/DeltaBundler/traverseDependencies.js:434:31
     at Array.map (<anonymous>)
     at resolveDependencies (/Users/dmg46664/IdeaProjects/Samson/node_modules/metro/src/DeltaBundler/traverseDependencies.js:431:18)
     at /Users/dmg46664/IdeaProjects/Samson/node_modules/metro/src/DeltaBundler/traverseDependencies.js:275:33
     at Generator.next (<anonymous>)
     at asyncGeneratorStep (/Users/dmg46664/IdeaProjects/Samson/node_modules/metro/src/DeltaBundler/traverseDependencies.js:87:24)
 #+end_src

 Info: https://github.com/vouch-opensource/krell

 I think this occurred when adding dependencies to deps.edn.
 Rejacking in, followed by reloading the app (not sure if npx / or reloading metro),
 made this go away.
*** TODO ERROR loading react-dom.inc.js
    [Thu Nov 12 2020 14:53:47.607]  ERROR     [Figwheel REPL] Error loading file http://localhost:9500/cljs-out/android/cljsjs/react-dom/development/react-dom.inc.js

    Strange as I can see this file. Error went away on reload.

    Suspect this is adb reverse proxy resolves this.
 Background reading:
 https://stackoverflow.com/questions/37320212/use-a-different-react-version-with-clojurescript-react-libraries-reagent-om-rum
 https://cljdoc.org/d/reagent/reagent/1.0.0-alpha2/doc/frequently-asked-questions/reagent-doesn-t-work-after-updating-dependencies

    https://stackoverflow.com/questions/21063587/what-is-index-js-used-for-in-node-js-projects
 https://stackoverflow.com/questions/44803681/how-to-use-index-js-instead-of-index-ios-js-index-android-js-in-react-native


 Getting dependencies
 #+begin_src shell
 ❯ clj -X:deps tree
 #+end_src


*** DONE how to get metro to show stacktraces? (Hint start debugger)
    CLOSED: [2020-11-14 Sat 14:59]
 https://stackoverflow.com/questions/49319291/how-to-debug-unexpected-token-in-react-native-metro

 Press d for developer menu inside app.
 The following from a terminal seems to have the same effect.
 #+begin_src shell
 adb shell input keyevent 82
 #+end_src

 This brings up the menu that allows starting and stopping of debugger.
 If you start the debugger, it will open up a tab in the browser with a webworker.
 If you open developer tools and look at the console, you'll see the same sets of errors
 and should be able to expand errors to get stacktraces.
*** DONE Adding dependencies
    CLOSED: [2020-11-16 Mon 12:20]
    Add deps to deps.edn
* TODO Clojure shell / Babashka
  https://www.youtube.com/watch?v=Nw8aN-nrdEk
  https://github.com/borkdude/babashka

  brew install borkdude/brew/babashka
* Refactoring
** C-c C-m rs     To call rs functions.
All functions in clj-refactor have a two-letter mnemonic shortcut. E.g. rs for cljr-rename-symbol. 
Given the prefix choice in the example setup you'd call this function by hitting 
https://github.com/clojure-emacs/clj-refactor.el/wiki
* Importing libraries
https://8thlight.com/blog/colin-jones/2010/12/05/clojure-libs-and-namespaces-require-use-import-and-ns.html
&
https://stackoverflow.com/questions/10358149/in-clojure-1-4-what-is-the-use-of-refer-within-require/10370672

How to import and require gen-classes
https://groups.google.com/forum/#!topic/clojure/9_xkNUEsgIc

Also
https://github.com/yogthos/clojure-error-message-catalog/blob/master/clj/class-not-found-exception.md

More on class loaders
https://www.baeldung.com/java-classloaders
* Destructuring
http://blog.brunobonacci.com/2014/11/16/clojure-complete-guide-to-destructuring/

https://stackoverflow.com/questions/3337888/clojure-named-arguments
* Forum topics
** Clojure spec greedy operators https://clojurians-log.clojureverse.org/clojure-spec/2018-01-04
* Tutorials
** Converting an app to docker tools.build https://www.youtube.com/watch?v=EYG4LrAa6XQ
** Sean corefield working at REPL https://www.youtube.com/watch?v=gIoadGfm5T8
** nbb https://www.youtube.com/watch?v=_-G9EKaAyuI
** Coverage of what clojure is https://www.youtube.com/watch?v=ciGyHkDuPAE
** Protocols! Must watch https://www.youtube.com/watch?v=kQhOlWXXl2I    
** TODO Datomic migration  https://grishaev.me/en/pg-to-datomic/
** TODO Building an ANKI clone using datomic https://www.youtube.com/watch?v=QrSnTIHotZE
** Literate devops https://www.youtube.com/watch?v=dljNabciEGg
** Transducers https://lambdaisland.com/episodes/transducers
** Training https://exercism.org/tracks/clojure
* Babashka
** Aws bb autocomplete https://github.com/jeroenvandijk/matryoshka
** Docker client https://github.com/lispyclouds/contajners
* NBB
** Replit NBB https://replit.com/@eccentric-j/Node-Babashka-ClojureScript-Template?v=1
* Clojurescript
** shadow karma testing https://www.arthurbrrs.me/testing-the-dom-using-shadow-and-reagent.html
** Re-frame tutorial https://day8.github.io/re-frame/dominoes-live/
** Reagent docs https://cljdoc.org/d/reagent/reagent/1.0.0-alpha2/doc/tutorials/creating-reagent-components
** CLJS JS interop     https://lwhorton.github.io/2018/10/20/clojurescript-interop-with-javascript.html 
** CLJS type inference https://blog.klipse.tech/clojure/2019/05/20/type-inference-in-clojurescript.html
** CLJS gotchas
   https://stackoverflow.com/questions/15049413/how-do-i-get-properties-with-dashes-in-their-names-in-clojurescript
** DEPRECATED Clojure script on react with figwheel https://medium.com/mindorks/building-mobile-apps-ios-and-android-with-clojurescript-4600235f826c
** DEPRECATED Clojurescript with ReactNative https://medium.com/upwork-engineering/developing-react-native-applications-in-clojurescript-9386b1cd5869
Basically start here:
https://cljsrn.org/
** CLJS Performance https://numergent.com/2015-12/ClojureScript-performance-revisited.html
* Useful clojure titbits
** shadlow-cljs & tools.build? https://clojurians-log.clojureverse.org/tools-build/2021-10-05/1633472745.474100
** Apply vs Map https://stackoverflow.com/questions/2311528/clojure-apply-vs-map
** Incrementing i https://stackoverflow.com/questions/4513078/i-equivalent-in-clojure
  also note the atom and swap example?

See map-indexed for a solution
 https://stackoverflow.com/questions/24798831/clojure-increment-a-counter
https://clojuredocs.org/clojure.core/map-indexed
https://clojuredocs.org/clojure.core/dissoc
** Odd examples https://stackoverflow.com/questions/44052252/what-does-clojure-function-jerry-means
** Two dots https://clojure.org/reference/java_interop#_the_dot_special_form
** doseq vs for (lazy)  https://stackoverflow.com/questions/4725417/difference-between-doseq-and-for-in-clojure
https://blog.jeaye.com/2016/07/27/clojure-for/

Tip. See the combination of doseq and map-index  https://github.com/mjul/docjure/blob/master/src/dk/ative/docjure/spreadsheet.clj#L267
** Reading wierd clojure characters https://clojure.org/guides/weird_characters
** Add index to a vector of maps (assoc & map-index) https://stackoverflow.com/questions/34490944/clojure-add-index-to-vector-of-maps
** Converting non lazy sequences (2nd answer)  https://stackoverflow.com/a/1645224/93074
** Prototyping https://grishaev.me/en/clj-args/
** How to download clojuredocs documentation offline
#+begin_src 
wget -k -m http://clojuredocs.org/
#+end_src

- In the css and cljs direcories, rename all the .js and .css files to end in precisely this suffix.


#+begin_src python
import SimpleHTTPServer
import SocketServer

PORT = 1234

class Handler(SimpleHTTPServer.SimpleHTTPRequestHandler):
    pass

Handler.extensions_map[''] = 'text/html'

httpd = SocketServer.TCPServer(("", PORT), Handler)

print "serving at port", PORT
httpd.serve_forever()
#+end_src

#+begin_src 
python server.py
#+end_src

https://docs.python.org/3/library/http.server.html
*** TODO Find a way so that the server shows pages without the .html in html format. This could be either with python or 
https://github.com/ring-clojure/ring/wiki/Getting-Started
** TODO How do Clojure return types work?
https://clojuredocs.org/clojure.core/doall

#+begin_src clojure
(def t (map inc [1 2 3]))
(type t) ; => clojure.lang.LazySeq

(type (seq '(1 2 3)))
(type '(1 2 3))

(doall t) ; => (2 3 4)
(str (doall t)) ; => clojure.lang.LazySeq
(str (vector t)) ; => [(2 3 4)]
(str (first (vector (doall t)))) ; => clojure.lang.LazySeq

(def x (str (vector t)))
(println x)




(str "test")
(println t)

(do
  (map inc [1 2 3])
  )

#+end_src
** Testing in clojure
Need an intro guide to testing your app with the repl?
Say you're Repl'ing your app and you want to run a test on a function change. How do you do this?

Some background.
https://stackoverflow.com/questions/21294294/run-tests-from-clojure-repl-and-leiningen
** Last repl exception  https://clojuredocs.org/clojure.core/*e
** Exercise to visualize functional: 
Have the user write code that takes records and tranforms it to legacy api.
I.e. takes a map, and has to take a dynamic list of excel columns
and put that data into a record in those columns, perhaps accommodating for different types:
i.e. formulas dates and values.
This should help the student understand the difference between creating data vs. walking over
the data tree maintaining state.
** TODO Another exercise

; figure out how get the following to return a simple list.

; Excercise
(genSummaryHeaders ["BTC" "EUR" "ETH" "GBP"] ["EUR"])
; Should return ("Date" "Summary" "BTC" "BTC Balance" ... same for other currencies "EUR fee")
; Or a vector
* Spec & generative testing
** Spec and test.check guides

https://clojure.org/guides/spec
https://clojure.org/guides/test_check_beginner

The spec guide introduces testing check fns for testing fn defs.
Hint: Rather first test functions with property tests and see where those simply port over to the simpler variety.

See the following for generators
https://github.com/clojure/test.check/blob/master/doc/generator-examples.md
** Difference between gen/fmap & gen/bind


gen/fmap. 

Every time this generator is asked to generate it: 
- generates a new value from the generator argument.
- Uses the value to prepare a new non-generator value to return.
- This generator is therefore a new fmap which produces these values.
- You can see below that it still calls the generator argument each time to fill out this vector

#+begin_src clojure
(gen/generate
 (gen/vector (gen/fmap (fn [x] (list x)) (gen/choose 1 5)))
 )
[(2) (4) (3) (4) (5) (4) (1) (3) (5) (1) (1) (2) (2) (3)]
#+end_src

gen/bind also:
- Uses the generator argument to generate values each time it is called. I.e. below is not equal.

#+begin_src clojure
(gen/generate (gen/bind (gen/vector gen/large-integer 3)
                        (fn [xs] (gen/vector (gen/shuffle xs) 2))))
[[0 28057239 -45698] [0 28057239 -45698]]

;; The vector of large ints will not be exploded, and still be a generator
;; that shuffle will work on.
(gen/generate (gen/vector (gen/shuffle (gen/vector gen/large-integer 3)) 2))
[[[:gen #function[clojure.test.check.generators/gen-fmap/fn--405]]]
 [[:gen #function[clojure.test.check.generators/gen-fmap/fn--405]]]]

;; Adding a generate is the equivalent of bind. I.e. it locks/binds the values at this point.
(gen/generate (gen/vector (gen/shuffle
                           (gen/generate (gen/vector gen/large-integer 3))) 2))

#+end_src

- However for bind, these values are used merely as arguments to a new generators (or a composition of generators) and the user of gen/bind must return this generator.

Note also how gen/let works
#+begin_src clojure
(gen/generate
 (gen/let 
 [n (gen/vector gen/small-integer 3)] ;; here the output of an iteration is bound.
   (gen/vector (gen/elements n)))) ;; however gen/elements here is not bound and so the vector is able to generate random items
[7 7 7 -2 -20 -20 -20 -20 7]

(gen/generate
 (gen/let [n (gen/vector gen/small-integer 3)
           e (gen/elements n) ;; However compared to the above, here elements is bound!
           v (gen/vector (gen/return e))] ;;It makes the example different, but regardless see how we are only aboe to get a single value.
   v))
[-15 -15 -15 -15 -15 -15]


;; However NOTE that the whole let block produces a generator, for which each call
;; is independent!!! this means that for below, although like the above examples a vector of 3
;; ints is generated and elements are selected from it.. each time the vector requires a new value
;; a new list of 3 small ints is generated and so the result is simply a random list!
(gen/generate
 (gen/vector
  (gen/let [n (gen/vector gen/small-integer 3)
            e (gen/elements n)]
    e)))
[-17 -6 1 -14 0 -25 17 -21 -26 -6 -2 -13 -5 27 -7 19]

#+end_src
** s/gen gotcha overriding map values

#+begin_src clojure
;; In 'ns'
(s/def ::spec (s/keys :req-un [::field]))

;; In other ns
(s/gen ::spec {
[::ns/field] #(gen/return :override) ;; Won't work! Presumably because ::spec is :req-un (but didn't test)
[:field] #(gen/return :override2) ;; Works!
})
#+end_src
** A vector of something as a fn argument https://stackoverflow.com/questions/43230546/a-clojure-spec-that-matches-and-generates-an-ordered-vector-of-variable-length

Example of Lack of expessivity out the box.

In order to understand Alex's answer, you'll need to understand gen/fmap.
Read the following as mandatory first https://clojure.org/guides/test_check_beginner
NOTE Some of the examples here are incorrect if using
[clojure.spec.gen.alpha :as gen]

(fmap as a name is a little misleading as it doesn't map the function to each item provided,
but runs the function with the result of the generator as an argument, bundling the result in 
another generator)

Then the example from comment in question, highlights further nuances
#+begin_src clojure
(s/def ::pattern (s/cat :sym symbol? :str string? :kws (s/* keyword?))) 
(s/def ::pattern-2 (s/cat :s string? :p ::pattern)) 
(s/valid? ::pattern ['af "5" :key]) 
;; true 
(s/valid? ::pattern-2 ["string" 'af "5" :key]) 
;; true 
(s/def ::pattern-3 (s/cat :s string? :p ::solution)) 
(s/valid? ::pattern-3 ["string" 'af "5" :key]) 
;; false !!! <- we are losing flatness 
(s/valid? ::pattern-3 ["string" ['af "5" :key]]) 
;; true !!! <- we are losing flatness 
#+end_src
** Common problem with spec. Cryptic error messages
*** Spec : nil TODO but why?
     Check the REPL for more information

#+begin_src clojure
 [clojure.spec.alpha :as s]
 [clojure.spec.gen.alpha :as gen]

gen/generate (s/gen ::coinbase-trade)) ;; should get only the generator in question as nothing has been added, even though it's already defined with-gen


1. Unhandled clojure.lang.ExceptionInfo
   Spec assertion failed.

         Spec: nil
        Value: nil

     Problems: 

                 alpha.clj:  282  clojure.spec.alpha/gensub
                 alpha.clj:  272  clojure.spec.alpha/gensub
                 alpha.clj:  877  clojure.spec.alpha/map-spec-impl/reify/rgen
                  core.clj: 2760  clojure.core/map/fn
              LazySeq.java:   42  clojure.lang.LazySeq/sval
              LazySeq.java:   51  clojure.lang.LazySeq/seq
                   RT.java:  531  clojure.lang.RT/seq
                  core.clj:  137  clojure.core/seq
                  core.clj: 2746  clojure.core/map/fn
              LazySeq.java:   42  clojure.lang.LazySeq/sval
              LazySeq.java:   51  clojure.lang.LazySeq/seq
#+end_src

You'll then see
#+begin_src 
Execution error (ExceptionInfo) at dmg46664.etl/eval16178 (form-init16923224181612635633.clj:413).
Unable to construct gen at: [:dmg46664.etl/date] for: :dmg46664.etl/date
#+end_src
*** class clojure.test.check.generators.Generator cannot be cast to class
Using (s/with-gen) with (gen/fmap) and not wrapping fmap in no-args function?

#+begin_src 
1. Unhandled java.lang.ClassCastException
   class clojure.test.check.generators.Generator cannot be cast to class
   clojure.lang.IFn (clojure.test.check.generators.Generator is in unnamed
   module of loader clojure.lang.DynamicClassLoader @218a78f6; clojure.lang.IFn
   is in unnamed module of loader 'app')

                 alpha.clj:  936  clojure.spec.alpha/spec-impl/reify
                 alpha.clj:  279  clojure.spec.alpha/gensub
                 alpha.clj:  272  clojure.spec.alpha/gensub
                 alpha.clj:  296  clojure.spec.alpha/gen
#+end_src
*** Wrong number of args (1) passed to: clojure.spec.alpha/def
Problem starting the REPL, 
None of my own code in the stacktrace

It turned out to be one of the standard defs. Wierd!? Why didn't it give me a line number?
It had nothing to do with test.check.generator/gen vs spec.gen.alpha/gen
** Niggles
- In order to do generative testing, the generators will often need to be at the level of the
container and not at the record level. Testing date aggregation code isn't so useful, if you
never generate records that share the same date. 
- This is mis-sold when learning about spec
as if defining structures let's 
** Test check api issues overriding generators
https://stackoverflow.com/questions/55436961/clojure-spec-override-check-generator-for-predicate
** Clojure spec for parsing https://juxt.pro/blog/posts/parsing-with-clojure-spec.html
Doesn't scale because no tokenization.
** Look at plugin project to see another limitation of spec.
** What is rose-tree in test.check?
http://blog.guillermowinkler.com/blog/2015/04/12/verifying-state-machine-behavior-using-test-dot-check/
** Exercise. Write a generator that selects 2 values from a list (and then use it).

A wasteful implementation

#+begin_src clojure
;; TODO It would be nice to remove the such-that as it's wasteful
(defn choose2 [g] (gen/such-that (fn [[x y]] (not= x y))
                                 (gen/let [x g
                                           y g]
                                   [x y])))
#+end_src

But you can't use it in gen/let

#+begin_src clojure
(gen/let [currencies (choose2 (gen/elements ["BTC" "EUR" "GBP"]))
           buy (first currencies) ;;NOTE fails here. Currencies is a generator, not a vector
           sell (second currencies)
           trade (s/gen ::trade
                        {
                         [::buyCurrency] #(buy)
                         [::sellCurrency] #(sell)
                         })]
   trade)
#+end_src
* Code snippets
** Be careful of macros
#+begin_src clojure
;; works
(let [f #(inc %)]
  (some-> 1 f))
;; doesn't work
(some-> 1 #(inc %))
#+end_src
** Query and filter classpath
#+begin_src 
(filter #(.contains % "clojure") (clojure.string/split (System/getProperty "java.class.path") #"\:"))
#+end_src
** Get methods out of instance
#+begin_src clojure

; useful fucntion
(use 'clojure.reflect)
(defn methods [obj]
  (->> (reflect obj)
      :members
      (map #(select-keys % [:name]))))

#+end_src
** Get methods out of class
https://clojuredocs.org/clojure.reflect/type-reflect
#+begin_src clojure
(use 'clojure.reflect)

(->> java.lang.Integer 
     clojure.reflect/type-reflect
     :members 
     (filter #(instance? clojure.reflect.Field %)) 
     (filter #(:public (:flags %)))
     (filter #(:static (:flags %)))
     (map #(vector (:name %) (:type %)))
     (sort)
     (pprint))

;;=> ([BYTES int]
;;    [MAX_VALUE int]
;;    [MIN_VALUE int]
;;    [SIZE int]
;;    [TYPE java.lang.Class])
#+end_src
** Print stacktrace
(clojure.stacktrace/print-stack-trace (Exception. "foo"))
* Tools + libs
** TODO https://github.com/cloverage/cloverage
** TODO Paredit https://www.youtube.com/watch?v=K0Tsa3smr1w
** https://github.com/dgrnbrg/spyscope
** Scala interop lib https://t6.github.io/from-scala/
** https://github.com/noprompt/meander
** Diffing code https://github.com/nextjournal/autochrome
** Clerk functions viewer https://www.loom.com/share/e61faf144a1c4feaac44d7ad9873366c
* Gotchas
** For actually lazy? http://blog.fogus.me/2010/01/22/de-chunkifying-Sequences-in-clojure/
   https://stackoverflow.com/questions/10556421/is-for-not-actually-lazy-in-clojure
** reduce or apply https://stackoverflow.com/questions/2891707/reduce-or-apply-using-logical-functions-in-clojure
** Autoresolution of keywords '::'  https://groups.google.com/forum/#!topic/clojure/i770QaIFiF0
** IllegalArgument with no help https://stackoverflow.com/questions/19590432/why-does-clojure-say-no-matching-method-for-an-illegal-argument
- This could happen when passing nil to a primitive parameter in java.
- Find this out by instrumenting the calling method in cider or equivalent.
** Equivalent https://clojureverse.org/t/1-2-equals-1-2/821/4
** Quoting and unbound function errors
https://8thlight.com/blog/colin-jones/2012/05/22/quoting-without-confusion.html
** Namespaced maps and destructuring
   https://stackoverflow.com/questions/38024650/how-can-i-use-my-specs-for-their-intended-purposes-if-they-are-in-a-separate-nam
   https://clojure.org/reference/reader#_map_namespace_syntax
** Spec gotchas
*** https://stackoverflow.com/questions/42530452/clojure-spec-validating-contents-of-maps
*** https://quanttype.net/posts/2021-03-06-clojure-spec-and-untrusted-input.html
*** https://ask.clojure.org/index.php/10356/unexpected-spec-failure-on-namespaced-keys-not-included-req?show=10356#q10356
* Opinionated Don'ts
** Threading of as-> https://stuartsierra.com/2018/07/15/clojure-donts-thread-as
** Core Async after watching promises https://www.youtube.com/watch?v=yJxFPoxqzWE
*** Prep JS Promises, callbacks, async & await: https://www.youtube.com/watch?v=PoRJizFvM7s
*** Rebuttal https://mauricio.szabo.link/blog/2020/06/11/clojurescript-vs-clojure-core-async/
Discovered https://github.com/babashka/nbb/issues/26#issuecomment-1116688001
*** See todolist for more evidence.
*** Testing core.async https://stackoverflow.com/questions/30766215/how-do-i-unit-test-clojure-core-async-go-macros
* Idiomatic clojure
** Depth first iteration and dispatch encapsulation hell!
If computer programs were artistic styles, then procedural programs would complete a drawing by tracing the outline, while clojure would build up a drawing from smaller shapes. Both methods would complete a drawing accurately.

When building up a program from idiomatic clojure, be careful to slip back into procedural ways
of doing things.


Consider the example below which is no doubt contrived but it's not diffficult to add 
extra criterion justifying the separation. Indeed the layout is not foreign and could
be simplified further only given there are no further dependencies.
#+begin_src clojure
(defn output-valid-hash! [m]
  (when (> (:hash m) -1695810776)
    (println m)
     )
  )

(defn output-hashed!
  [m]
  (output-valid-hash!
   (assoc m :hash (some-> m :name hash))
                      )
  )

(defn output-names!
  [names]
  ;; Imagine this is long and complicated
  (doseq [n names]
    (output-hashed! (assoc {} :name n))
    )
  )

(output-names! ["John" "James" "Michael"])

#+end_src


The above only prints a record for Michael and you want to confirm why.
In this case you may suspect the when around the println, but you want to test it easily.
Perhaps it may also be assumptions about the creation of the map values.


It's quite hard to test this code, because at each level there is some unpacking and repacking.
There is a mental burden of understanding the context at each level.
Having to rely on a debugger is not ideal.
It's possible to make code changes to test the results, but these changes are distributed, making
them error prone.

It's positive that this code is depth first. It doesn't start processing the second name until the first is completed. It could potentially work on a stream of names,
but addressing them one at a time.
It can also be argued that the functions are available for processing code at different levels of completeness.

Compare this to the clojure idiomatic:

#+begin_src clojure
(->> ["John" "James" "Michael"]
     (map #(if (string? %)
             (assoc {} :name %)
             %)
          )
     (map #(assoc % :hash (hash (:name %))))
     (filter #(> (:hash %) -1695810776))
     (println)
     )
#+end_src

Advantages:
- Can operate on a stream of strings or maps with :name already.
- It's possible to comment out the filter in one line and see the result.
- Can see the result to the repl by commenting out the println (Dont' need to change the
return values of the functions).

NOTE this is only possible with Clojure's laziness model. Otherwise this pipeline would not be depth first and not appropriate for streams! It's also only possible in this 

Java streams can help as an equivalence but there be dragons  https://jaxenter.com/java-8-streams-lazy-136183.html
https://4comprehension.com/java-stream-api-was-broken-before-jdk10/
* Interesting reads
** TODO Speed up webapp https://www.juxt.pro/blog/clojurescript-app-performance
** TODO Monorepo https://corfield.org/blog/2021/02/23/deps-edn-monorepo/
** Is data still a good idea? https://news.ycombinator.com/item?id=11945722
** Funding? https://www.clojuriststogether.org/news/q3-2021-survey-results/
** Performance tuning https://www.youtube.com/watch?v=5BKn4rUoggg
** Java time https://nextjournal.com/schmudde/java-time
** Transient data structures https://clojure.org/reference/transients
** Missing elegant API for manipulating immutable data structures http://nathanmarz.com/blog/clojures-missing-piece.html
** Clojure workflow tips https://clojureverse.org/t/share-the-nitty-gritty-details-of-your-clojure-workflow/1208/23
** Reloading woes https://lambdaisland.com/blog/2018-02-09-reloading-woes
** Nested hash map anti pattern? (Only required in rare circumstances) https://hackernoon.com/nested-maps-considered-harmful-143add482247
** Nil punning https://lispcast.com/nil-punning/
** Interesting threading https://www.spacjer.com/blog/2015/11/09/lesser-known-clojure-variants-of-threading-macro/
** Maps vs records  http://discuss.purelyfunctional.tv/t/when-to-use-map-vs-defrecord/933
** Keywords vs Symbols https://blog.robphoenix.com/clojure/notes-on-clojure-keywords-symbols/
** gen-class
Overview
https://kotka.de/blog/2010/02/gen-class_how_it_works_and_how_to_use_it.html
More on gen-class
https://stackoverflow.com/questions/42617678/gen-class-in-clojure-and-use-it-immediately

Official documentation with examples!
https://clojure.org/reference/compilation

See class loading issues
** Class loading issues with generated classes
https://medium.com/@minfuyang/about-java-classloader-dynamic-class-generation-in-apache-spark-case-43a6d492c78f
** Subclassing https://puredanger.github.io/tech.puredanger.com/2011/08/12/subclassing-in-clojure/
** Proxying abstract classes https://stackoverflow.com/questions/53090419/clojure-proxy-implementing-abstract-class-with-protected-constructor
** Logging https://juxt.pro/blog/posts/logging.html
** Clojure safety information in the following comments http://clojuredocs.org/clojure.core/read
** No lazy vectors in clojure https://stackoverflow.com/questions/3083535/clojure-lazy-sequences-that-are-vectors
** Macro expansion warning https://ask.clojure.org/index.php/9015/spec-error-on-simple-threading-in-clj-cljs
** Datafy & Nav http://corfield.org/blog/2018/12/03/datafy-nav
https://ask.clojure.org/index.php/8550/can-someone-explain-the-arguments-to-nav
** Clojure slow startup time http://clojure-goes-fast.com/blog/clojures-slow-start/
Follow up and patch here
https://groups.google.com/g/clojure/c/jNWf19LvszU/m/iKZSKVLBAgAJ
https://github.com/forax/clojure
** Java decompilation http://clojure-goes-fast.com/blog/introspection-tools-java-decompilers/
** Deps & Cli limitations https://clojureverse.org/t/how-to-effectively-use-deps-cli/4787/4
And supplementations https://github.com/clojure/tools.deps.alpha/wiki/Tools
** Specter vs Transducer code sample https://gist.github.com/borkdude/5f9a4ae710217e893a9462ff90b6cac3
** Decompiling Clojure (3 parts)  http://blog.guillermowinkler.com/blog/2014/04/13/decompiling-clojure-i/
** Equivalent of node.js non-blocking? https://stackoverflow.com/questions/24980014/can-i-make-a-fully-non-blocking-backend-application-with-http-kit-and-core-async
** TODO Datomic vs GraphQL https://www.indiehackers.com/post/a-time-saving-alternative-for-graphql-da674d0961
https://maxweber.github.io/blog/2019-06-15-approaching-the-web-after-tomorrow-part-3
https://maxweber.github.io/blog/2019-08-05-introducing-db-view-part-2
** Flatten, apply concat & friends http://chouser.n01se.net/apply-concat/
And some playing around
#+begin_src clojure
(def y
  (for [x ["sdfasf" "adfa" "erqewr"]]
    (seq x))
  )

(identity y) ;; => ((\s \d \f \a \s \f) (\a \d \f \a) (\e \r \q \e \w \r))
(map type y) ;; => (clojure.lang.StringSeq clojure.lang.StringSeq clojure.lang.StringSeq)
(apply concat y)
#+end_src
** TODO What React alone vs Reframe https://purelyfunctional.tv/article/react-vs-re-frame/
** Navigating tree comparison Java and Clojure https://insideclojure.org/images/j-treevisit-pdf.pdf
** Transducers for xpath / tree navigation https://www.juxt.pro/blog/xpath-in-transducers
** Cider
*** cider hook http://root42.blogspot.com/2014/08/how-to-automatically-refresh-cider-when.html
*** Making clojure lazier & streams https://clojure.org/reference/lazy
*** Deep dive into sequences
Easy start with: https://medium.com/@pwentz/laziness-in-clojure-3d83645bf7f3

More concisely: https://insideclojure.org/2015/01/02/sequences/

Then to pick apart the details of types: https://stackoverflow.com/questions/44095400/how-to-understand-clojures-lazy-seq/44102122
* Videos
** TODO Task : Make a doubly nested for loop, calling on a Java API (XLS) spreadsheet, to take a data structure and save it to tables.
https://github.com/mjul/docjure

The naive way that a java programmer would code:
- Assuming the need for for counters.
- There is a need for counters. Docjure got around it by querying the underlying data!
- Made a mistake for vs deseq
- Made a mistake or at least didn't realize that I'd reached the point to start breaking functions up. This is good!
- At least we figured out map-indexed!

#+begin_src clojure
(defn save-excel! []
  (println "saving excel spreadsheet")
  (let [workbook (XSSFWorkbook.)
        sheet (.createSheet workbook "Datatypes in Java")
        datatypes [["Datatypes", "Type", "Size(in bytes)"]
                   ["int", "Primitive", 2]
                   ["float", "Primitive", 4]
                   ["double", "Primitive", 8]
                   ["char", "Primitive", 1]
                   ["String", "Non-Primitive", "No fixed size"]]
        rowNum 0

        ]
    (for [row_data datatypes
          :let [row (. sheet createRow rowNum)
                ]]
      ;; The following causes a side effect
      (dorun (map-indexed  #(let [cell (. row createCell (inc %1))] (.setCellValue cell %2)
                          )
                    row_data))
      )
    (try (doto workbook (.write (FileOutputStream. "myfile.xls")) (.close))
         (catch Exception e (.printStackTrace e)))
    )
  )


(save-excel!)
#+end_src
** Scope capture https://vimeo.com/237220354
** Clojure for ETLs https://www.youtube.com/watch?v=oOON--g1PyU
** Introduction to CS and Reagent https://www.yqqqoutube.com/watch?v=wq6ctyZBb0A
* Improvements
** Ensure that stacktrace window is colour coded obvious to communicate whether it's a runtime error or compile time error.
** Thread about how to compensate for the lack of dot https://www.reddit.com/r/Clojure/comments/6f6cq2/how_to_compensate_for_clojures_lack_of_dot/
** The stacktrace window should allow one ot preview items without go
** To clojurephant
; (in [1 2] 1) ; like .contains
; (expand-case) to expand out case test-contants.
* Thoughts?
** Side-effects and pure functions.
Is relying on the following var in subsequent functions impure?
#+begin_src clojure
  (def handlers {:connection handler)
#+end_src
If it is, then there's an irony to that.
Because it's just pointing at functions in the same way that all
the language is based on.
Why would you do it? See the daemon I'm writing...
* Failed experiments
** cond%

   cond%1 just means cond% experiment 1 in the following

  #+begin_src clojure
    
    ;; TODO should imp [cond body]* as argument
    (defmacro cond%1 [cond outcome]
      (let [g (gensym)
            g_cond (clojure.walk/postwalk-replace {'% g} cond)
            g_outcome (clojure.walk/postwalk-replace {'% g} outcome)]
        `(fn [~g] (if ~g_cond ~g_outcome ~g)))
      )
    
    (-> :a
        ((cond%1 (= % :a) :b)))
    ;; becomes =>
    (-> :a
        (#(if (= % :a) :b %)))
    
    ;; The following is not possible NOTE
    (-> :a
        (cond%1 (= % :a) :b))
    
    
    
  #+end_src
 However, that's not a big enough improvement!
 And given the ideal is not possible, I think it's a failure for now.
 
